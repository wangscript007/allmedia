
user  root;
#daemon off;
#master_process off;
worker_processes  1;

#error_log  logs/error.log debug;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

worker_rlimit_core 10240000000;
working_directory /tmp/;


events {
    worker_connections  2048;
    multi_accept on;
    reuse_port on; 
    use epoll;
}

rtmp {
    server {

        listen 1935;

        chunk_size 4000;

        # video on demand
        application vod {
            play /mnt/vod/;
        }
        
        # live video
        application live {
            live on;
            hls  on;
            hls_path /mnt/live/;
            hls_fragment 2s;
        }
    }
}

http {
    
    upstream kalapi {
        server @WWW_HOST@;
    }
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 60;
    keepalive_requests 1000;
    client_header_timeout 20;
    client_body_timeout 20;
    reset_timedout_connection on;
    send_timeout 20;

    #gzip  on;
    #gzip_types application/vnd.apple.mpegurl video/f4m application/dash+xml text/xml;
    
    # common vod settings
    vod_mode local;
    vod_upstream_location /kalapi_proxy;
    vod_upstream_extra_args "pathOnly=1";

    # shared memory zones
    vod_metadata_cache metadata_cache 512m;
    vod_mapping_cache mapping_cache 64m;
    vod_response_cache response_cache 64m;
    vod_performance_counters perf_counters;

    # common file caching / aio
    open_file_cache max=1000 inactive=5m;
    open_file_cache_valid 2m;
    open_file_cache_min_uses 1;
    open_file_cache_errors on;
    aio on;

    server {
        listen       8080;
        
        ##########################NGINX VIDEO ZK MODEUL ###########################
        #sch_zk_address 192.168.1.1;192.168.1.2;
        #sch_zk_path    /video/;
        #sch_zk_update  5s;
        #sch_signal_ip  192.168.1.8;
        #sch_service_ip 192.168.1.8;
        #sch_disk_vpath /mnt/;
        
        # static files (crossdomain.xml, robots.txt etc.) + fallback to api
        location / {
            root   html;
            try_files $uri @api_fallback;
        }
        ###########################NGINX VIDEO TASK MODULE#########################
        # for the transcode task operate 
        location /task {
            video_task;
            task_count 0;
        }
        ###########################NGINX VIDEO STAT MODULE#########################
        # for the transcode task operate 
        location /task_stat {
            video_stat;
            manage_password allcam123;
        }
        ###########################NGINX HTTP MANAGE MODULE########################
        # for the file system operate
        location /manage {
            video_manage;
            video_path /home/update/;
        }
        # for the file download(video file)
        location /download {
            set $vpath $arg_vpath;
            alias /home/update;
            add_header Cache-Control no-cache;
        }
        ###########################NGINX UPLOAD MODULE#############################
        # for upload the files
        location /upload {
            upload_pass @OK;
            upload_cleanup 400 404 499 500-505;
            upload_store /home/update;
            upload_store_access user:rw;
        }
        location @OK {
            return 200;
        }
        
        location /up {
            alias html;
        }
        ###########################NGINX HTTP HLS MODULE###########################
        #for the hls live play
        location /live {
            set $vpath $arg_vpath;
            # Serve HLS fragments
            types {
                application/x-mpegURL m3u8;
                video/mpeg ts;
            }
            video_hls;
            hls_vod on;
            alias /mnt/live;
            vpath /home/update/;
            keepalive_timeout  0; 
            expires 15m; 
        }
        # for the hls vod play
        location /vod {
            set $vpath $arg_vpath;
            # Serve HLS fragments
            types {
                application/x-mpegURL m3u8;
                video/mpeg ts;
            }
            video_hls;
            hls_vod on;
            alias /home/update/vod;
            vpath /home/update/;
            keepalive_timeout  0;
            expires 15m;
        }  
        
        ###########################NGINX VOD MODULE################################
        # nginx status page
        location /nginx_status {
            stub_status on;
            access_log off;
        }

        # vod status page
        location /vod_status {
            vod_status;
            access_log off;
        }
        
        # internal location for vod subrequests
        location /kalapi_proxy/ {
            internal;
            proxy_pass http://kalapi/;
            proxy_set_header Host $http_host;
        }
        
        # serve flavor progressive (clipFrom/To are not supported with 'vod none' so they are proxied)
        location ~ ^/p/\d+/(sp/\d+/)?serveFlavor/((?!clipFrom)(?!clipTo).)*$ {
            vod none;

            add_header Last-Modified "Sun, 19 Nov 2000 08:52:00 GMT";
            expires 100d;
        }
        
        # serve flavor HLS
        location ~ ^/hls/p/\d+/(sp/\d+/)?serveFlavor/ {
            vod hls;
            vod_bootstrap_segment_durations 2000;
            vod_bootstrap_segment_durations 2000;
            vod_bootstrap_segment_durations 2000;
            vod_bootstrap_segment_durations 4000;

            add_header Last-Modified "Sun, 19 Nov 2000 08:52:00 GMT";
            add_header Access-Control-Allow-Headers "*";
            add_header Access-Control-Expose-Headers "Server,range,Content-Length,Content-Range";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Origin "*";
            expires 100d;
        }
        
        # serve flavor DASH
        location ~ ^/dash/p/\d+/(sp/\d+/)?serveFlavor/ {
            vod dash;
            vod_segment_duration 4000;
            vod_bootstrap_segment_durations 3500;
            vod_align_segments_to_key_frames on;
            vod_dash_manifest_format segmenttemplate;
            
            add_header Last-Modified "Sun, 19 Nov 2000 08:52:00 GMT";
            add_header Access-Control-Allow-Headers "origin,range,accept-encoding,referer";
            add_header Access-Control-Expose-Headers "Server,range,Content-Length,Content-Range";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Origin "*";
            expires 100d;
        }
        
        # serve flavor HDS
        location ~ ^/hds/p/\d+/(sp/\d+/)?serveFlavor/ {
            vod hds;
            vod_segment_duration 6000;
            vod_align_segments_to_key_frames on;
            vod_segment_count_policy last_rounded;
            
            add_header Last-Modified "Sun, 19 Nov 2000 08:52:00 GMT";
            add_header Access-Control-Allow-Origin "*";
            expires 100d;
        }

        # serve flavor MSS
        location ~ ^/mss/p/\d+/(sp/\d+/)?serveFlavor/ {
            vod mss;
            vod_segment_duration 4000;
            vod_manifest_segment_durations_mode accurate;
            
            add_header Last-Modified "Sun, 19 Nov 2000 08:52:00 GMT";
            expires 100d;
        }   
        
        # all unidentified requests fallback to api (inc. playManifest)
        location @api_fallback {
            proxy_pass http://kalapi;
            proxy_set_header Host $http_host;
        }
        
        ###########################ERROR CODE CONF##########################

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
